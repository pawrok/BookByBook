#:kivy 2.0
#:import C kivy.utils.get_color_from_hex


<RootRoot>:
    orientation: 'vertical'
    BoxLayout:
        id: top_panel
        canvas:
            Color:
                rgb: 0.85, .6, .6
            Rectangle:
                pos: self.pos
                size: self.size
        size_hint_y: 0.07
        Label:
            text: "BookByBook"
            font_name: 'fonts/Amatic.ttf'
            font_size: '28sp'

    RootScreenManager:
        id: rootmanager

    BoxLayout:
        id: bottommenu
        orientation: 'horizontal'
        size_hint_y: None
        height: '60dp'
        padding: '5dp'
        canvas:
            Color:
                rgb: 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
            # Color:
            #     rgb: 0, 0, 0
            # Line:
            #     points: self.pos[0] + 15, self.pos[1] + self.size[1], self.pos[0] + self.size[0] - 15, self.pos[1] + self.size[1]
            #     width: 1

        BottomButton:
            btn_text: 'Home'
            on_release:
                app.add_home_screen()
                rootmanager.current = 'home'
            btn_source: 'images/png/home.png'

        BottomButton:
            btn_text: 'Stats'
            on_release: rootmanager.current = 'stats'
            btn_source: 'images/png/file.png'

        BottomButton:
            btn_text: 'New'
            on_release:
                app.add_newbook_screen()
                rootmanager.current = 'new'
            btn_source: 'images/png/add.png'

        BottomButton:
            btn_text: 'Wishlist'
            on_release: rootmanager.current = 'wish'
            btn_source: 'images/png/wishlist.png'

        BottomButton:
            btn_text: 'Settings'
            on_release: rootmanager.current = 'settings'
            btn_source: 'images/png/settings.png'

<BottomButton@Button>:
    btn_text: ''
    btn_source: ''
    background_normal: ''
    background_color: 1, 1, 1, 0

    BoxLayout:
        pos: self.parent.pos
        size: self.parent.size
        orientation: 'vertical'
        Image:
            source: root.btn_source
            size_hint: 1, 0.7
        Label:
            size_hint: 1, 0.3
            text: root.btn_text
            color: 0, 0, 0
            font_size: '13sp'


<RootScreenManager>:
    id: rootmanager
    home_screen: home_screen.__self__
    size: root.width, root.height
    HomeScreen:
        id: home_screen
    StatsScreen:
    AddScreen:
    WishScreen:
    SettingsScreen:

<HomeButton@Button>:
    background_normal: ''
    background_color: 1, 1, 1, 1
    color: 0, 0, 0, 1
    font_size: '17sp'
    canvas:
        Color:
            rgba: root.line_color
        Line:
            points: root.pos[0] + 10, root.pos[1], root.pos[0] + root.size[0] - 10, root.pos[1]
            width: 2
            joint: 'miter'
            cap: 'none'


<HomeScreen>:
    name: "home"
    id: home_screen
    middlemanager: middlemanager
    BoxLayout:
        canvas:
            Color:
                rgb: 0.3, 0.3, 0.3
            Rectangle:
                pos: self.pos
                size: self.size
        orientation: 'vertical'

        BoxLayout:
            padding: '4dp', '2dp', '4dp', '2dp'
            size_hint_y: None
            height: '38dp'
            canvas:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            BoxLayout:
                orientation: 'horizontal'
                HomeButton:
                    id: books
                    text: 'Books'
                    line_color: 0.85, .6, .6, 1
                    on_release:
                        middlemanager.current = 'book'; \
                        self.set_underline([0.85, .6, .6, 1]); \
                        shelf.set_underline([0, 0, 0, 0]); \
                        tags.set_underline([0, 0, 0, 0])
                HomeButton:
                    id: shelf
                    text: 'Shelves'
                    on_release:
                        middlemanager.current = 'shelf'; \
                        self.set_underline([0.85, .6, .6, 1]); \
                        books.set_underline([0, 0, 0, 0]); \
                        tags.set_underline([0, 0, 0, 0])
                HomeButton:
                    id: tags
                    text: 'Tags'
                    on_release:
                        middlemanager.current = 'tag'; \
                        self.set_underline([0.85, .6, .6, 1]); \
                        shelf.set_underline([0, 0, 0, 0]); \
                        books.set_underline([0, 0, 0, 0])

        BoxLayout:
            size_hint_y: None
            height: '38dp'
            padding: '2dp', '2dp', '2dp', '2dp'
            canvas:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            BoxLayout:
                padding: '2dp', '1dp', '2dp', '2dp'
                canvas.before:
                    Color:
                        rgba: 1, 1, 1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size

                Label:
                    size_hint_x: 0.05
                TextInput:
                    id: search_input
                    multiline: False
                    size_hint_x: 0.75
                    background_normal: ''
                    background_active: ''
                    background_disabled_normal: ''
                    background_color: 1, 1, 1, 1
                    font_size: 15
                    foreground_color: 1, 0, 0, 1
                    hint_text: 'Search'

                    canvas.before:
                        Color:
                            rgb: 0.3, 0.3, 0.3, 1
                    canvas.after:
                        Color:
                            rgb: 0, 0, 0, 1
                        Line:
                            points: self.pos[0] , self.pos[1], self.pos[0] + self.size[0], self.pos[1]
                            # width: 2

                Button:
                    id: search_btn
                    size_hint_x: 0.08
                    background_normal: ''
                    background_color: 1, 1, 1, 0
                    on_press: root.middlemanager.ids.books_screen.ids.book_scroll.search_title(search_input.text)
                    Image:
                        allow_stretch: True
                        size: search_btn.width * 0.7, search_btn.height * 0.7
                        source: 'images/search.png'
                        pos: search_btn.x + search_btn.size[0] * 0.3, search_btn.y + search_btn.size[1] * 0.15
                # Label:
                #     size_hint_x: 0.05
                Button:
                    id: sort_btn
                    background_normal: ''
                    background_color: 1, 1, 1, 0
                    size_hint_x: 0.12
                    Image:
                        allow_stretch: True
                        size: sort_btn.width * 0.8, sort_btn.height * 0.8
                        source: 'images/sort.png'
                        pos: sort_btn.x + sort_btn.size[0] * 0.2, sort_btn.y + sort_btn.size[1] * 0.1

        MiddleScreenManager:
            id: middlemanager
            # size_hint_y: None

<AddScreen>:
    name: 'new'
    stars_rating: stars_rating
    fav_btn: fav_btn
    read_btn: read_btn
    add_image_btn: add_image_btn

    BoxLayout:
        orientation: 'vertical'
        padding: '12dp', '4dp'
        canvas:
            Color:
                rgb: 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            padding: '1dp', '0dp'
            id: topaddbook
            orientation: 'horizontal'
            size_hint_y: 0.25
            AddImageButton:
                id: add_image_btn
                background_normal: ''
                background_color: 1, 1, 1, 1
                size_hint_x: 0.37
                on_press: self.add_book_image()
                Image:
                    allow_stretch: True
                    size: add_image_btn.size
                    source: 'images/book2.png'
                    pos: add_image_btn.pos

            BoxLayout:
                padding: '5dp', '0dp'
                size_hint_x: 0.63
                orientation: 'vertical'
                canvas:
                    Color:
                        rgb: 1, 1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size

                StarsButton:
                    id: stars_rating
                    size_hint_y: 0.45

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: 0.55

                    ReadButton:
                        id: read_btn
                        background_normal: ''
                        background_color: 1, 1, 1, 1
                        size_hint: .7, .5
                        width: self.height
                        pos_hint: {'y': 0.2}
                        on_press: self.set_read_status(self.isRead)

                        Label:
                            text: 'Read'
                            color: 0, 0, 0, 1
                            size: read_btn.width * 0.6, read_btn.height * 0.6
                            pos: read_btn.x + 4, read_btn.y + 7

                        Image:
                            id: read_img
                            allow_stretch: True
                            size: read_btn.width * 0.4, read_btn.height * 0.4
                            source: 'images/blank.png'
                            pos: read_btn.x + 38, read_btn.y + 12

                    Label:
                        size_hint_x: 0.08

                    FavButton:
                        # background_normal: ''
                        # background_color: 1, .9, .9, .99
                        id: fav_btn
                        size_hint: .3, .5
                        pos_hint: {'y': 0.2}
                        background_normal: ''
                        background_color: 1, 1, 1, 1
                        color: 0, 0, 0, 1
                        on_press: self.set_favourite(self.is_fav)

                        Image:
                            id: img
                            allow_stretch: True
                            size: fav_btn.size
                            source: 'images/heart_black.png'
                            pos: fav_btn.pos

                    Label:
                        size_hint_x: 0.1

                    Button:
                        size_hint: .9, .9
                        # size_hint_y: .6
                        background_normal: ''
                        background_color: 1, 1, 1, 1
                        text: 'Save book'
                        color: 0, 0, 0              #self.root.children[1].current_screen.ids['input_title'].ids['text_input'].text
                        on_press:
                            if root.book_id > 0: \
                            app.update_book_in_db(
                            root.book_id, input_title.ids['text_input'].text, input_author.ids['text_input'].text,
                            input_category.ids['text_input'].text, stars_rating.rating, input_rented_person.ids['text_input'].text,
                            input_date_completed.ids['text_input'].text, input_pages.ids['text_input'].text, read_btn.isRead,
                            add_image_btn.imageDest, fav_btn.is_fav, input_description.ids['text_input'].text); \
                            print(root.book_id)
                            # root.reset_properties()
                            else: \
                            app.add_book_to_db(
                            input_title.ids['text_input'].text, input_author.ids['text_input'].text, input_category.ids['text_input'].text,
                            stars_rating.rating, input_rented_person.ids['text_input'].text,
                            input_date_completed.ids['text_input'].text, input_pages.ids['text_input'].text, read_btn.isRead,
                            add_image_btn.imageDest, fav_btn.is_fav, input_description.ids['text_input'].text);
                            # root.reset_properties()

        BoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.75
            id: titleauthorstuff
            BookTextInput:
                id: input_title
                book_property: root.input_title
                label_txt: 'Title'
                hint_txt: 'title'
                size_hint_y: 0.15
            BookTextInput:
                id: input_author
                book_property: root.input_author
                label_txt: 'Author'
                hint_txt: 'author'
                size_hint_y: 0.15
            BookTextInput:
                id: input_category
                book_property: root.input_category
                label_txt: 'Category'
                hint_txt: 'category'
                size_hint_y: 0.15
            BookTextInput:
                id: input_rented_person
                book_property: root.input_rented_person
                label_txt: 'Rented to'
                hint_txt: "person's name"
                size_hint_y: 0.15
            BookTextInput:
                id: input_date_completed
                book_property: root.input_date_completed
                label_txt: 'Date completed'
                hint_txt: 'date'
                size_hint_y: 0.15
            BookTextInput:
                id: input_pages
                size_hint_y: 0.15
                label_txt: 'Number of pages'
                book_property: str(root.input_pages)

            BookTextInput:
                id: input_description
                size_hint_y: None
                label_txt: 'Description and notes'
                hint_txt: 'description'
                book_property: root.input_description

<BookTextInput@BoxLayout>:
    label_txt: ''
    hint_txt: ''
    book_property: ''
    orientation: 'vertical'
    # padding: '5dp', '0dp'
    canvas.after:
        Color:
            rgb: 0, 0, 0, 1
        Line:
            points: self.pos[0] + 6 , self.pos[1], self.pos[0] + self.size[0] - 6, self.pos[1]

    Label:
        height: '4dp'
        size_hint_y: None

    BoxLayout:
        height: '17dp'
        orientation: 'horizontal'
        size_hint_y: None
        Label:
            size_hint_x: None
            width: '6dp'
        Label:
            # size_hint_x: None
            text: root.label_txt
            text_size: self.size
            halign: 'left'
            color: 0.4, 0.4, 0.4, 1

    TextInput:
        id: text_input
        # size_hint_y: 0.6
        background_active: ''
        background_color: 1, 1, 1, 1
        background_disabled_normal: ''
        background_normal: ''
        font_size: 15
        foreground_color: 0, 0, 0, 1
        text: root.book_property
        # hint_text: root.hint_txt
        # canvas.after:
        #     Color:
        #         rgb: 0, 0, 0, 1
        #     Line:
        #         points: self.pos[0] , self.pos[1], self.pos[0] + self.size[0], self.pos[1]
                # width: 2



<StatsScreen>:
    name: "stats"
    BoxLayout:
        orientation: 'vertical'
        canvas:
            Color:
                rgb: 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size

<WishScreen>:
    name: "wish"
    BoxLayout:
        canvas:
            Color:
                rgb: 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size

<SettingsScreen>:
    name: "settings"
    BoxLayout:
        canvas:
            Color:
                rgb: 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        Button:
            text: "DELETE ALL BOOKS"
            on_press: root.delete_DB()

<StarsButton>:
    orientation: 'horizontal'
    padding: '0dp', '10dp', '0dp', '15dp'

    Button:
        id: first_s
        size_hint_y: 0.8
        background_normal: ''
        background_color: 1, 1, 1, 1
        color: 0, 0, 0, 1
        on_press:
            root.set_rating(1)
        Image:
            allow_stretch: True
            size: first_s.size
            source: 'images/star_empty.png'
            pos: first_s.pos


    Button:
        id: sec_s
        size_hint_y: 0.8
        background_normal: ''
        background_color: 1, 1, 1, 1
        color: 0, 0, 0, 1
        on_press:
            root.set_rating(2)
        Image:
            allow_stretch: True
            size: sec_s.size
            source: 'images/star_empty.png'
            pos: sec_s.pos

    Button:
        id: third_s
        size_hint_y: 0.8
        background_normal: ''
        background_color: 1, 1, 1, 1
        color: 0, 0, 0, 1
        on_press:
            root.set_rating(3)
        Image:
            allow_stretch: True
            size: third_s.size
            source: 'images/star_empty.png'
            pos: third_s.pos

    Button:
        id: fourth_s
        size_hint_y: 0.8
        background_normal: ''
        background_color: 1, 1, 1, 1
        color: 0, 0, 0, 1
        on_press:
            root.set_rating(4)
        Image:
            allow_stretch: True
            size: fourth_s.size
            source: 'images/star_empty.png'
            pos: fourth_s.pos

# ----------------------- home screens ------------------------- #

<MiddleScreenManager>:
    id: middlemanager
    books_screen: books_screen
    Books:
        id: books_screen
    Shelves:
    Tags:

<Books>:
    name: 'book'
    id: books_screen
    book_scroll: book_scroll
    BoxLayout:
        padding: 10
        canvas:
            Color:
                rgb: 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BookScrollView:
            id: book_scroll
            # size_hint: (1, None)
            # size_hint_y: None
            # height: root.height
            do_scroll_x: False
            do_scroll_y: True

<Shelves>:
    name: 'shelf'
    canvas:
        Color:
            rgb: 1, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size
    ShelfViewer:
        # data: app.data
        # spacing: 800
        # padding: 300, 300
        viewclass: 'ShelfItem'
        # space_x: self.size[0]/3
        # orientation: "vertical"
        RecycleBoxLayout:
            orientation: "vertical"
            default_size: dp(100), dp(50)
            # col_default_width: self.width / 4
            # default_size_hint: None, None
            # size_hint_y: None
            # spacing: dp(2)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height

<Tags>:
    name: 'tag'
    canvas:
        Color:
            rgb: 1, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size

    Label:
        text: "tag screen"


# widgets for MiddleScreenManager

<BookItem>:
    # height: root.height
    # width: self.width
    height: self.width * 1.4
    orientation: 'vertical'
    size_hint_y: None
    # size_hint_x: None

    Button:
        id: cover_btn
        background_normal: ''
        background_color: 1, 1, 1, 1
        size_hint_y: 0.8
        on_release: app.open_edit_book(root.book_id)
        Image:
            allow_stretch: True
            size: cover_btn.width, cover_btn.height
            source: root.cover
            pos: cover_btn.x, cover_btn.y


    Label:
        size_hint_y: 0.2
        color: 0.5, .2, .3, 0.6
        text: root.title

<ShelfItem>:

    BoxLayout:
        orientation: 'vertical'
        padding: '5dp'

        Button:
            size_hint_y: 0.2
            text: root.shelf_title
